%% Calculate the optimized trajectories for 5 link biped model with GRF

addpath dyn/
addpath grad/
addpath robotGen/
addpath obj/
addpath gaitCon/
%% simulation parameter

param.numJ=5;
param.toe_th = 1e-2;

param.gaitT = 1;
param.sampT = 0.01;

param.gaitLen = 1;

time = 0:param.sampT:param.gaitT;

% set torque/angular velocity constraints
max_tau = 30;
max_vel = 30/180*pi;
%% initialize joint pos and torque
qmax = 170/180/pi;
q = qmax*sin((2*time/param.gaitT+randn(param.jointNum,1))*pi);
dq = qmax*sin((2*time/param.gaitT+randn(param.jointNum,1))*pi)*10;

u = zeros(param.jointNum,length(q));

ext_tau = zeros(size(time,2),param.jointNum);

x0 = [q;dq;u];
prob.x0 = x0;


% dyndq = @(x,tauext)dyn_dq(x,tauext,jointNum,toe_th);
% rowfun(dyndq,table(x,ext_tau))

%% define constraints
%  dynamic+gait length + vertical pos
prob.nonlcon = @(x)five_link_nonlcon(x,param);

% linear constraints
prob.beq = zeros(param.numJ,1);
Aeq = zeros(param.numJ,size(x,1)*size(x,2));
Aeq(1:param.numJ,1:param.numJ)=[1,1,1,1,1;
                                0,0,0,0,1;
                                0,0,0,1,0;
                                0,0,1,0,0;
                                0,1,0,0,0;];
Aeq(1:param.numJ,end-param.numJ*3+1:end-param.numJ*2) = [-1,0,0,0,0;
                                                          0,1,0,0,0;
                                                          0,0,1,0,0;
                                                          0,0,0,1,0;
                                                          0,0,0,0,1;];
prob.Aeq = Aeq;

% upper limit and lower limit for each joints
prob.ub = [pi*ones(1,size(x,2));
           zeros(1,size(x,2));
           pi/2*ones(1,size(x,2));
           -pi/2*ones(1,size(x,2));
           pi*ones(1,size(x,2));
           max_vel*ones(p,size(x,2));
           



%% define object function
prob.objective = @(x)objFun(x,param);




%% solve

options = optimoptions('fmincon','MaxIter',1e3,'MaxFunEvals',1e3,...
    'Display','iter','GradObj','on','TolCon',1e-6,'SpecifyConstraintGradient',true,...
    'SpecifyObjectiveGradient',true);
prob.options = options;
prob.solver = 'fmincon';

fmincon(prob)